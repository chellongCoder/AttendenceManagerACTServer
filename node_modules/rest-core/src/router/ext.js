const BaseRouter = require('./base');
const ExtensionManager = require('rest-extensions');
const Utils = require('../utils');

class ExtRouter extends BaseRouter {
    constructor(_rootPath) {
        super(_rootPath);
    }
    config() {
        const extensions = new ExtensionManager().getExtensions();
        extensions.forEach(item => {
            for (let i = 0; i < item.modules.length; i++) {
                item.modules[i]['dir'] = item.dir;
            }
        })
        const modules = Utils.flatten(extensions.map( item => item.modules ));
        modules.forEach(item => {
            const dir = this.getRootPath() + '/extensions';
            const Module = require(dir + item.dir + '/modules/' + item.source);
            const instance = new Module();            
            this.addRouter(item.method, item.path, instance.process.bind(instance));    
        });
    }
}

module.exports = ExtRouter;